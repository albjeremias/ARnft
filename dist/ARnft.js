!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("web-worker:./ARnftWorker")):"function"==typeof define&&define.amd?define(["exports","web-worker:./ARnftWorker"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ARNFT={},t.Worker)}(this,(function(t,e){"use strict";function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=r(e),i="undefined"!=typeof Float32Array?Float32Array:Array;function o(t,e){var r=new i(3);!function(t,e){var r=e[0],s=e[1],i=e[2],o=e[4],n=e[5],a=e[6],h=e[8],c=e[9],l=e[10];t[0]=Math.hypot(r,s,i),t[1]=Math.hypot(o,n,a),t[2]=Math.hypot(h,c,l)}(r,e);var s=1/r[0],o=1/r[1],n=1/r[2],a=e[0]*s,h=e[1]*o,c=e[2]*n,l=e[4]*s,u=e[5]*o,d=e[6]*n,f=e[8]*s,p=e[9]*o,_=e[10]*n,v=a+u+_,w=0;return v>0?(w=2*Math.sqrt(v+1),t[3]=.25*w,t[0]=(d-p)/w,t[1]=(f-c)/w,t[2]=(h-l)/w):a>u&&a>_?(w=2*Math.sqrt(1+a-u-_),t[3]=(d-p)/w,t[0]=.25*w,t[1]=(h+l)/w,t[2]=(f+c)/w):u>_?(w=2*Math.sqrt(1+u-a-_),t[3]=(f-c)/w,t[0]=(h+l)/w,t[1]=.25*w,t[2]=(d+p)/w):(w=2*Math.sqrt(1+_-a-u),t[3]=(h-l)/w,t[0]=(f+c)/w,t[1]=(d+p)/w,t[2]=.25*w),t}function n(){var t=new i(3);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function a(t,e,r){var s=new i(3);return s[0]=t,s[1]=e,s[2]=r,s}function h(t,e,r){var s=e[0],i=e[1],o=e[2],n=r[0],a=r[1],h=r[2];return t[0]=i*h-o*a,t[1]=o*n-s*h,t[2]=s*a-i*n,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var c,l=function(t){var e=t[0],r=t[1],s=t[2];return Math.hypot(e,r,s)};c=n();!function(){var t,e=(t=new i(4),i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();function u(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function d(t,e,r,s){var i,o,n,a,h,c=e[0],l=e[1],u=e[2],d=e[3],f=r[0],p=r[1],_=r[2],v=r[3];return(o=c*f+l*p+u*_+d*v)<0&&(o=-o,f=-f,p=-p,_=-_,v=-v),1-o>1e-6?(i=Math.acos(o),n=Math.sin(i),a=Math.sin((1-s)*i)/n,h=Math.sin(s*i)/n):(a=1-s,h=s),t[0]=a*c+h*f,t[1]=a*l+h*p,t[2]=a*u+h*_,t[3]=a*d+h*v,t}var f,p,_,v,w,y,m,g=function(t,e){var r=e[0],s=e[1],i=e[2],o=e[3],n=r*r+s*s+i*i+o*o;return n>0&&(n=1/Math.sqrt(n)),t[0]=r*n,t[1]=s*n,t[2]=i*n,t[3]=o*n,t};f=n(),p=a(1,0,0),_=a(0,1,0),v=u(),w=u(),y=new i(9),i!=Float32Array&&(y[1]=0,y[2]=0,y[3]=0,y[5]=0,y[6]=0,y[7]=0),y[0]=1,y[4]=1,y[8]=1,m=y;class E{}class M{constructor(t,e,r,s){this._processing=!1,this.position=n(),this.rotation=u(),this._dispatcher=t,this.markerURL=e,this.vw=r,this.vh=s}initialize(t){return new Promise(((e,r)=>{this.worker=new s.default,this.worker.onmessage=r=>{this.load(t).then((()=>{this.worker.onmessage=t=>{let e;if("found"==t.data.type){let r=this.getArrayMatrix(JSON.parse(t.data.matrixGL_RH)),s=function(t,e,r,s,o,n,a,h,c,l,u,d,f,p,_,v){var w=new i(16);return w[0]=t,w[1]=e,w[2]=r,w[3]=s,w[4]=o,w[5]=n,w[6]=a,w[7]=h,w[8]=c,w[9]=l,w[10]=u,w[11]=d,w[12]=f,w[13]=p,w[14]=_,w[15]=v,w}(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15]);!function(t,e){t[0]=e[12],t[1]=e[13],t[2]=e[14]}(this.position,s),o(this.rotation,s),e=new E,e.matrix=s.values(),e.position=this.position.values(),e.rotation=this.rotation.values()}this._dispatcher.found(e),this._processing=!1},e(!0)}))}}))}getArrayMatrix(t){var e=[];for(var r in t)e[r]=t[r];return e}process(t){this._processing||(this._processing=!0,this.worker.postMessage({type:"process",imagedata:t}))}load(t){return new Promise(((e,r)=>{var s=320/Math.max(this.vw,this.vh/3*4);let i=this.vw*s,o=this.vh*s,n=Math.max(i,o/3*4),a=Math.max(o,i/4*3);this.worker.postMessage({type:"load",pw:n,ph:a,camera_para:t,marker:this.markerURL}),this.worker.onmessage=t=>{var r=t.data;switch(r.type){case"loaded":JSON.parse(r.proj);break;case"endLoading":1==r.end&&e(!0)}this._processing=!1}}))}}class R{constructor(t,e,r,s){this._nodes=[],this._markerURL=e,this._worker=new M(this,this._markerURL,r,s),this._nodes.push(t)}initialize(t){return this._cameraURL=t,this._worker.initialize(this._cameraURL)}found(t){this._nodes.forEach((e=>{e.found(t)}))}process(t){this._worker.process(t)}update(){this._nodes.forEach((t=>{t.update()}))}destroy(){}}class A{constructor(t,e){this.count=0,this._controllers=new Map,this._fps=15,this._lastTime=0,this._videoRenderer=t,this._cameraDataURL=e,this.setFPS(this._fps)}addNFTEntity(t,e){return e||(e="entity-"+this.count++),this._controllers.set(e,t),t}addNFTEntity2(t,e,r){r||(r="entity-"+this.count++);let s=new R(t,e,120,120);this._controllers.set(r,s)}getEntityByName(t){return this._controllers.has(t)?this._controllers.get(t):null}getCameraView(){return this._videoRenderer}setFPS(t){this._fps=1e3/t}getConf(t){fetch(t).then((t=>{if(!t.ok)throw new Error("HTTP error, status = "+t.status);return t.json()})).then((t=>{console.log(t);const e=new CustomEvent("getConfig",{detail:{config:t}});return document.dispatchEvent(e),t})).catch((function(t){return console.error(t),Promise.reject(!1)})),document.addEventListener("getConfig",(t=>{this.appData=t.detail.config})),console.log(this.appData)}initialize(){console.log("init ARnft");let t=[];return this._controllers.forEach((e=>{t.push(e.initialize(this._cameraDataURL))})),Promise.all(t).then((()=>!0))}update(){let t,e=Date.now();e-this._lastTime>this._fps&&(t=this._videoRenderer.getImage(),this._lastTime=e),this._controllers.forEach((e=>{e.update(),t&&e.process(t)}))}destroy(){this._controllers.forEach((t=>{t.destroy()})),this._controllers.clear(),this._videoRenderer=null}}A.EVENT_SET_CAMERA="ARNFT_SET_CAMERA_EVENT",A.EVENT_FOUND_MARKER="ARNFT_FOUND_MARKER_EVENT",A.EVENT_LOST_MARKER="ARNFT_LOST_MARKER_EVENT",t.ARnft=A,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=ARnft.js.map
