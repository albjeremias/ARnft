!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("web-worker:./ARnftWorker")):"function"==typeof define&&define.amd?define(["exports","web-worker:./ARnftWorker"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ARNFT={},t.Worker)}(this,(function(t,e){"use strict";function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=i(e),r="undefined"!=typeof Float32Array?Float32Array:Array;function o(t,e){var i=new r(3);!function(t,e){var i=e[0],s=e[1],r=e[2],o=e[4],n=e[5],a=e[6],h=e[8],c=e[9],l=e[10];t[0]=Math.hypot(i,s,r),t[1]=Math.hypot(o,n,a),t[2]=Math.hypot(h,c,l)}(i,e);var s=1/i[0],o=1/i[1],n=1/i[2],a=e[0]*s,h=e[1]*o,c=e[2]*n,l=e[4]*s,d=e[5]*o,u=e[6]*n,p=e[8]*s,v=e[9]*o,_=e[10]*n,w=a+d+_,f=0;return w>0?(f=2*Math.sqrt(w+1),t[3]=.25*f,t[0]=(u-v)/f,t[1]=(p-c)/f,t[2]=(h-l)/f):a>d&&a>_?(f=2*Math.sqrt(1+a-d-_),t[3]=(u-v)/f,t[0]=.25*f,t[1]=(h+l)/f,t[2]=(p+c)/f):d>_?(f=2*Math.sqrt(1+d-a-_),t[3]=(p-c)/f,t[0]=(h+l)/f,t[1]=.25*f,t[2]=(u+v)/f):(f=2*Math.sqrt(1+_-a-d),t[3]=(h-l)/f,t[0]=(p+c)/f,t[1]=(u+v)/f,t[2]=.25*f),t}function n(){var t=new r(3);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function a(t,e,i){var s=new r(3);return s[0]=t,s[1]=e,s[2]=i,s}function h(t,e,i){var s=e[0],r=e[1],o=e[2],n=i[0],a=i[1],h=i[2];return t[0]=r*h-o*a,t[1]=o*n-s*h,t[2]=s*a-r*n,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var c,l=function(t){var e=t[0],i=t[1],s=t[2];return Math.hypot(e,i,s)};c=n();!function(){var t,e=(t=new r(4),r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();function d(){var t=new r(4);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function u(t,e,i,s){var r,o,n,a,h,c=e[0],l=e[1],d=e[2],u=e[3],p=i[0],v=i[1],_=i[2],w=i[3];return(o=c*p+l*v+d*_+u*w)<0&&(o=-o,p=-p,v=-v,_=-_,w=-w),1-o>1e-6?(r=Math.acos(o),n=Math.sin(r),a=Math.sin((1-s)*r)/n,h=Math.sin(s*r)/n):(a=1-s,h=s),t[0]=a*c+h*p,t[1]=a*l+h*v,t[2]=a*d+h*_,t[3]=a*u+h*w,t}var p,v,_,w,f,g,m,y=function(t,e){var i=e[0],s=e[1],r=e[2],o=e[3],n=i*i+s*s+r*r+o*o;return n>0&&(n=1/Math.sqrt(n)),t[0]=i*n,t[1]=s*n,t[2]=r*n,t[3]=o*n,t};p=n(),v=a(1,0,0),_=a(0,1,0),w=d(),f=d(),g=new r(9),r!=Float32Array&&(g[1]=0,g[2]=0,g[3]=0,g[5]=0,g[6]=0,g[7]=0),g[0]=1,g[4]=1,g[8]=1,m=g;class R{}class M{constructor(t,e,i,s){this._processing=!1,this.position=n(),this.rotation=d(),this._dispatcher=t,this.markerURL=e,this.vw=i,this.vh=s}initialize(t){return new Promise(((e,i)=>{this.worker=new s.default,this.worker.onmessage=i=>{this.load(t).then((()=>{this.worker.onmessage=t=>{let e;if("found"==t.data.type){let i=this.getArrayMatrix(JSON.parse(t.data.matrixGL_RH)),s=function(t,e,i,s,o,n,a,h,c,l,d,u,p,v,_,w){var f=new r(16);return f[0]=t,f[1]=e,f[2]=i,f[3]=s,f[4]=o,f[5]=n,f[6]=a,f[7]=h,f[8]=c,f[9]=l,f[10]=d,f[11]=u,f[12]=p,f[13]=v,f[14]=_,f[15]=w,f}(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9],i[10],i[11],i[12],i[13],i[14],i[15]);!function(t,e){t[0]=e[12],t[1]=e[13],t[2]=e[14]}(this.position,s),o(this.rotation,s),e=new R,e.matrix=s.values(),e.position=this.position.values(),e.rotation=this.rotation.values()}this._dispatcher.found(e),this._processing=!1},e(!0)}))}}))}getArrayMatrix(t){var e=[];for(var i in t)e[i]=t[i];return e}process(t){this._processing||(this._processing=!0,this.worker.postMessage({type:"process",imagedata:t}))}load(t){return new Promise(((e,i)=>{var s=320/Math.max(this.vw,this.vh/3*4);let r=this.vw*s,o=this.vh*s,n=Math.max(r,o/3*4),a=Math.max(o,r/4*3);this.worker.postMessage({type:"load",pw:n,ph:a,camera_para:t,marker:this.markerURL}),this.worker.onmessage=t=>{var i=t.data;switch(i.type){case"loaded":JSON.parse(i.proj);break;case"endLoading":1==i.end&&e(!0)}this._processing=!1}}))}}class E{constructor(t,e,i,s){this._nodes=[],this._markerURL=e,this._worker=new M(this,this._markerURL,i,s),this._nodes.push(t)}initialize(t){return this._cameraURL=t,this._worker.initialize(this._cameraURL)}found(t){this._nodes.forEach((e=>{e.found(t)}))}process(t){this._worker.process(t)}update(){this._nodes.forEach((t=>{t.update()}))}destroy(){}}class T{constructor(t){this.canvas_process=document.createElement("canvas"),this.context_process=this.canvas_process.getContext("2d"),this.video=t}getHeight(){return this.vh}getWidth(){return this.vw}getImage(){return this.context_process.drawImage(this.video,0,0,this.vw,this.vh,this.ox,this.oy,this.w,this.h),this.context_process.getImageData(0,0,this.pw,this.ph)}initialize(t){return this._facing=t.facingMode||"environment",new Promise((async(t,e)=>{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var i={audio:!1,video:{facingMode:this._facing,width:{min:480,max:640}}};navigator.mediaDevices.getUserMedia(i).then((async i=>{this.video.srcObject=i,this.video=await new Promise(((t,e)=>{this.video.onloadedmetadata=()=>t(this.video)})).then((e=>{this.vw=this.video.videoWidth,this.vh=this.video.videoHeight;var i=320/Math.max(this.vw,this.vh/3*4);return this.w=this.vw*i,this.h=this.vh*i,this.pw=Math.max(this.w,this.h/3*4),this.ph=Math.max(this.h,this.w/4*3),this.ox=(this.pw-this.w)/2,this.oy=(this.ph-this.h)/2,this.canvas_process.width=this.pw,this.canvas_process.height=this.ph,this.context_process.fillStyle="black",this.context_process.fillRect(0,0,this.pw,this.ph),t(!0),e})).catch((t=>(console.log(t),e(t),null)))})).catch((t=>{console.error(t),e(t)}))}else e("Sorry, Your device does not support this experince.")}))}}class A{constructor(t,e){this.count=0,this._controllers=new Map,this._fps=15,this._lastTime=0,this._videoRenderer=t,this._cameraDataURL=e,this.setFPS(this._fps)}addNFTEntity(t,e){return e||(e="entity-"+this.count++),this._controllers.set(e,t),t}addNFTEntity2(t,e,i){i||(i="entity-"+this.count++);let s=new E(t,e,120,120);this._controllers.set(i,s)}getEntityByName(t){return this._controllers.has(t)?this._controllers.get(t):null}getCameraView(){return this._videoRenderer}setFPS(t){this._fps=1e3/t}async init(t,e,i){!function(t,e){fetch(t).then((t=>{if(!t.ok)throw new Error("HTTP error, status = "+t.status);return t.json()})).then((t=>(console.log(t),e=t,console.log(e),t))).catch((function(t){return console.error(t),Promise.reject(!1)}))}(t,this.appData),console.log(this.appData),this._videoRenderer=new T(document.getElementById("video")),null!==this.appData&&await this._videoRenderer.initialize(this.appData.videoSettings).catch((t=>(console.log(t),Promise.reject(!1))));const s=new A(this._videoRenderer,e);return await s.initialize().catch((t=>(console.log(t),Promise.reject(!1)))),!0}async init2(t,e,i){let s;this._videoRenderer=new T(document.getElementById("video")),function(t,e){fetch(t).then((t=>{if(!t.ok)throw new Error("HTTP error, status = "+t.status);return t.json()})).then((t=>{console.log(t),e(t)})).catch((function(t){return console.error(t),Promise.reject(!1)}))}(t,(t=>{s=t,console.log(this.appData)})),this.appData=s,console.log(this.appData),await this._videoRenderer.initialize(this.appData.videoSettings).catch((t=>(console.log(t),Promise.reject(!1))));const r=new A(this._videoRenderer,e);return await r.initialize().catch((t=>(console.log(t),Promise.reject(!1)))),!0}async init3(t,e,i){this._videoRenderer=new T(document.getElementById("video")),fetch(t).then((t=>{if(!t.ok)throw new Error("HTTP error, status = "+t.status);return t.json()})).then((async t=>{console.log(t),this.appData=t,await this._videoRenderer.initialize(this.appData.videoSettings).catch((t=>(console.log(t),Promise.reject(!1))))}));const s=new A(this._videoRenderer,e);return await s.initialize().catch((t=>(console.log(t),Promise.reject(!1)))),!0}initialize(){console.log("init ARnft");let t=[];return this._controllers.forEach((e=>{t.push(e.initialize(this._cameraDataURL))})),Promise.all(t).then((()=>!0))}update(){let t,e=Date.now();e-this._lastTime>this._fps&&(t=this._videoRenderer.getImage(),this._lastTime=e),this._controllers.forEach((e=>{e.update(),t&&e.process(t)}))}destroy(){this._controllers.forEach((t=>{t.destroy()})),this._controllers.clear(),this._videoRenderer=null}}A.EVENT_SET_CAMERA="ARNFT_SET_CAMERA_EVENT",A.EVENT_FOUND_MARKER="ARNFT_FOUND_MARKER_EVENT",A.EVENT_LOST_MARKER="ARNFT_LOST_MARKER_EVENT",t.ARnft=A,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=ARnft.js.map
