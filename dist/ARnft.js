!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ARNFT={})}(this,(function(t){"use strict";var e=null;try{var i="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");e=i.Worker}catch(t){}function s(t,i,s){var r=void 0===i?null:i,o=function(t,e){return Buffer.from(t,"base64").toString(e?"utf16":"utf8")}(t,void 0!==s&&s),n=o.indexOf("\n",10)+1,a=o.substring(n)+(r?"//# sourceMappingURL="+r:"");return function(t){return new e(a,Object.assign({},t,{eval:!0}))}}function r(t,e,i){var s=void 0===e?null:e,r=function(t,e){var i=atob(t);if(e){for(var s=new Uint8Array(i.length),r=0,o=i.length;r<o;++r)s[r]=i.charCodeAt(r);return String.fromCharCode.apply(null,new Uint16Array(s.buffer))}return i}(t,void 0!==i&&i),o=r.indexOf("\n",10)+1,n=r.substring(o)+(s?"//# sourceMappingURL="+s:""),a=new Blob([n],{type:"application/javascript"});return URL.createObjectURL(a)}var o="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var n,a,h,c=(n="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwohZnVuY3Rpb24oYSl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIGUoYSl7cmV0dXJuIGEmJiJvYmplY3QiPT10eXBlb2YgYSYmImRlZmF1bHQiaW4gYT9hOntkZWZhdWx0OmF9fXZhciB0PWUoYSk7b25tZXNzYWdlPWE9Pntjb25zdCBlPWEuZGF0YTtzd2l0Y2goZS50eXBlKXtjYXNlImxvYWQiOnJldHVybiB2b2lkIG4oZSk7Y2FzZSJwcm9jZXNzIjpyPWUuaW1hZ2VkYXRhLGQoKX19O2xldCByPW51bGwsbz1udWxsLHM9bnVsbDtjb25zdCBuPWE9Pntjb25zdCBlPXNlbGYub3JpZ2luO2xldCByLG47Y29uc29sZS5kZWJ1ZygiQmFzZSBwYXRoOiIsZSk7Y29uc3QgZD0vaHR0cHM/OlwvXC8od3d3XC4pP1stYS16QS1aMC05QDolLl9cK34jPV17MiwyNTZ9XC5bYS16XXsyLDZ9XGIoWy1hLXpBLVowLTlAOiVfXCsufiMoKT8mLy89XSopL2dpbS50ZXN0KGEuY2FtZXJhX3BhcmEpOzE9PWQ/cj1hLmFkZFBhdGg/ZSsiLyIrYS5hZGRQYXRoKyIvIithLmNhbWVyYV9wYXJhOmEuY2FtZXJhX3BhcmE6MD09ZCYmKHI9YS5hZGRQYXRoP2UrIi8iK2EuYWRkUGF0aCsiLyIrYS5jYW1lcmFfcGFyYTplKyIvIithLmNhbWVyYV9wYXJhKSxjb25zb2xlLmRlYnVnKCJMb2FkaW5nIGNhbWVyYSBhdDoiLHIpLHQuZGVmYXVsdC5BUkNvbnRyb2xsZXJORlQuaW5pdFdpdGhEaW1lbnNpb25zKGEucHcsYS5waCxyKS50aGVuKCh0PT57bz10O2NvbnN0IHI9by5nZXRDYW1lcmFNYXRyaXgoKTtvLmFkZEV2ZW50TGlzdGVuZXIoImdldE5GVE1hcmtlciIsKGE9PntzPXt0eXBlOiJmb3VuZCIsbWF0cml4R0xfUkg6SlNPTi5zdHJpbmdpZnkoYS5kYXRhLm1hdHJpeEdMX1JIKX19KSk7Y29uc3QgZD0vaHR0cHM/OlwvXC8od3d3XC4pP1stYS16QS1aMC05QDolLl9cK34jPV17MiwyNTZ9XC5bYS16XXsyLDZ9XGIoWy1hLXpBLVowLTlAOiVfXCsufiMoKT8mLy89XSopL2dpbS50ZXN0KGEubWFya2VyKTsxPT1kP249YS5hZGRQYXRoP2UrIi8iK2EuYWRkUGF0aCsiLyIrYS5tYXJrZXI6YS5tYXJrZXI6MD09ZCYmKG49YS5hZGRQYXRoP2UrIi8iK2EuYWRkUGF0aCsiLyIrYS5tYXJrZXI6ZSsiLyIrYS5tYXJrZXIpLGNvbnNvbGUuZGVidWcoIkxvYWRpbmcgTkZUIG1hcmtlciBhdDogIixuKSxvLmxvYWRORlRNYXJrZXIobikudGhlbigoYT0+e3Bvc3RNZXNzYWdlKHt0eXBlOiJuZnREYXRhIixuZnQ6SlNPTi5zdHJpbmdpZnkoYSl9LCIqIiksby50cmFja05GVE1hcmtlcklkKGEuaWQpLGNvbnNvbGUubG9nKCJsb2FkTkZUTWFya2VyIC0+ICIsYS5pZCksY29uc29sZS5sb2coYSkscG9zdE1lc3NhZ2Uoe3R5cGU6ImVuZExvYWRpbmciLGVuZDohMH0sIioiKX0pKS5jYXRjaCgoYT0+e2NvbnNvbGUuZXJyb3IoIkVycm9yIGluIGxvYWRpbmcgbWFya2VyIG9uIFdvcmtlciIsYSl9KSkscG9zdE1lc3NhZ2Uoe3R5cGU6ImxvYWRlZCIscHJvajpKU09OLnN0cmluZ2lmeShyKX0sIioiKX0pKS5jYXRjaCgoYT0+e2NvbnNvbGUuZXJyb3IoYSl9KSl9LGQ9KCk9PntzPW51bGwsbyYmby5wcm9jZXNzJiZvLnByb2Nlc3Mocikscz9wb3N0TWVzc2FnZShzLCIqIik6cG9zdE1lc3NhZ2Uoe3R5cGU6Im5vdCBmb3VuZCJ9LCIqIikscj1udWxsfX0oQVJUb29sa2l0TkZUKTsKCg==",a=null,h=!1,o?s(n,a,h):function(t,e,i){var s;return function(o){return s=s||r(t,e,i),new Worker(s,o)}}(n,a,h));class l{constructor(t,e,i,s){this._processing=!1,this._dispatcher=t,this.markerURL=e,this.vw=i,this.vh=s}initialize(t){return new Promise(((e,i)=>{this.worker=new c,this.load(t).then((()=>{e(!0)}))}))}process(t){this._processing||(this._processing=!0,this.worker.postMessage({type:"process",imagedata:t}))}load(t){return new Promise(((e,i)=>{var s=320/Math.max(this.vw,this.vh/3*4);let r=this.vw*s,o=this.vh*s,n=Math.max(r,o/3*4),a=Math.max(o,r/4*3);this.worker.postMessage({type:"load",pw:n,ph:a,camera_para:t,marker:this.markerURL}),this.worker.onmessage=t=>{var i=t.data;switch(i.type){case"loaded":JSON.parse(i.proj);break;case"endLoading":1==i.end&&e(!0)}this._processing=!1}}))}destroy(){}}class d{constructor(t,e,i,s){this._nodes=[],this._markerURL=e,this._worker=new l(this,this._markerURL,i,s),this._nodes.push(t)}initialize(t){return this._cameraURL=t,this._worker.initialize(this._cameraURL)}found(t){this._nodes.forEach((e=>{e.found(t)}))}process(t){this._worker.process(t)}update(){this._nodes.forEach((t=>{t.update()}))}destroy(){}}class u{constructor(t,e){this.count=0,this._controllers=new Map,this._fps=15,this._lastTime=0,this._videoRenderer=t,this._cameraDataURL=e,this.setFPS(this._fps)}addNFTEntity(t,e){return e||(e="entity-"+this.count++),this._controllers.set(e,t),t}addNFTEntity2(t,e,i){i||(i="entity-"+this.count++);let s=new d(t,e,120,120);this._controllers.set(i,s)}getEntityByName(t){return this._controllers.has(t)?this._controllers.get(t):null}getCameraView(){return this._videoRenderer}setFPS(t){this._fps=1e3/t}initialize(){console.log("init ARnft");let t=[];return this._controllers.forEach((e=>{t.push(e.initialize(this._cameraDataURL))})),Promise.all(t).then((()=>!0))}update(){let t,e=Date.now();e-this._lastTime>this._fps&&(t=this._videoRenderer.getImage(),console.log(t),this._lastTime=e),this._controllers.forEach((e=>{e.update(),t&&e.process(t)}))}destroy(){this._controllers.forEach((t=>{t.destroy()})),this._controllers.clear(),this._videoRenderer=null}}u.EVENT_SET_CAMERA="ARNFT_SET_CAMERA_EVENT",u.EVENT_FOUND_MARKER="ARNFT_FOUND_MARKER_EVENT",u.EVENT_LOST_MARKER="ARNFT_LOST_MARKER_EVENT";class p{constructor(){this._hasFound=!1,this._frameDrops=0}update(){this.world||(this._hasFound=!1,this._frameDrops=0)}found(t){this.world=t}}class m{constructor(t){this.canvas_process=document.createElement("canvas"),this.context_process=this.canvas_process.getContext("2d"),this.video=t}getHeight(){return this.vh}getWidth(){return this.vw}getImage(){return this.context_process.drawImage(this.video,0,0,this.vw,this.vh,this.ox,this.oy,this.w,this.h),this.context_process.getImageData(0,0,this.pw,this.ph)}initialize(t){return this._facing=t.facingMode||"environment",new Promise((async(t,e)=>{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var i={audio:!1,video:{facingMode:this._facing,width:{min:480,max:640}}};navigator.mediaDevices.getUserMedia(i).then((async i=>{this.video.srcObject=i,this.video=await new Promise(((t,e)=>{this.video.onloadedmetadata=()=>t(this.video)})).then((e=>{this.vw=this.video.videoWidth,this.vh=this.video.videoHeight;var i=320/Math.max(this.vw,this.vh/3*4);return this.w=this.vw*i,this.h=this.vh*i,this.pw=Math.max(this.w,this.h/3*4),this.ph=Math.max(this.h,this.w/4*3),this.ox=(this.pw-this.w)/2,this.oy=(this.ph-this.h)/2,this.canvas_process.width=this.pw,this.canvas_process.height=this.ph,this.context_process.fillStyle="black",this.context_process.fillRect(0,0,this.pw,this.ph),t(!0),e})).catch((t=>(console.log(t),e(t),null)))})).catch((t=>{console.error(t),e(t)}))}else e("Sorry, Your device does not support this experince.")}))}}t.ARnft=class{constructor(t,e,i){this.camData=e,this.configUrl=t,this.markerUrl=i}async initialize(){var t;return t=this.configUrl,fetch(t).then((t=>{if(!t.ok)throw new Error("HTTP error, status = "+t.status);return t.json()})).then((t=>{console.log(t);const e=new CustomEvent("getConfig",{detail:{config:t}});return document.dispatchEvent(e),t})).catch((function(t){return console.error(t),Promise.reject(!1)})),document.addEventListener("getConfig",(async t=>{this.appData=t.detail.config,console.log(this.appData),this.cameraView=new m(document.getElementById("video")),await this.cameraView.initialize(this.appData.videoSettings).catch((t=>(console.error(t),Promise.reject(!1)))),this._arnftCore=new u(this.cameraView,this.camData),await this._arnftCore.initialize().catch((t=>(console.error(t),Promise.reject(!1))));let e=new p,i=new d(e,this.markerUrl,200,200);await i.initialize(this.camData),this._arnftCore.addNFTEntity(i),this._arnftCore.update()})),Promise.resolve(!0)}createEntity(t,e,i,s){}addNFTEntity(t,e){return this._arnftCore.addNFTEntity(t,e)}update(){console.log(this._arnftCore),this._arnftCore.update()}},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=ARnft.js.map
