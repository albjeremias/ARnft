!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("web-worker:./ARnftWorker"),require("fs"),require("path")):"function"==typeof define&&define.amd?define(["exports","web-worker:./ARnftWorker","fs","path"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ARNFT={},t.Worker,t.fs,t.path)}(this,(function(t,e,i,s){"use strict";function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o=r(e),n=r(s),a="undefined"!=typeof Float32Array?Float32Array:Array;function h(t,e){var i=new a(3);!function(t,e){var i=e[0],s=e[1],r=e[2],o=e[4],n=e[5],a=e[6],h=e[8],c=e[9],l=e[10];t[0]=Math.hypot(i,s,r),t[1]=Math.hypot(o,n,a),t[2]=Math.hypot(h,c,l)}(i,e);var s=1/i[0],r=1/i[1],o=1/i[2],n=e[0]*s,h=e[1]*r,c=e[2]*o,l=e[4]*s,d=e[5]*r,u=e[6]*o,p=e[8]*s,v=e[9]*r,_=e[10]*o,f=n+d+_,w=0;return f>0?(w=2*Math.sqrt(f+1),t[3]=.25*w,t[0]=(u-v)/w,t[1]=(p-c)/w,t[2]=(h-l)/w):n>d&&n>_?(w=2*Math.sqrt(1+n-d-_),t[3]=(u-v)/w,t[0]=.25*w,t[1]=(h+l)/w,t[2]=(p+c)/w):d>_?(w=2*Math.sqrt(1+d-n-_),t[3]=(p-c)/w,t[0]=(h+l)/w,t[1]=.25*w,t[2]=(u+v)/w):(w=2*Math.sqrt(1+_-n-d),t[3]=(h-l)/w,t[0]=(p+c)/w,t[1]=(u+v)/w,t[2]=.25*w),t}function c(){var t=new a(3);return a!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function l(t,e,i){var s=new a(3);return s[0]=t,s[1]=e,s[2]=i,s}function d(t,e,i){var s=e[0],r=e[1],o=e[2],n=i[0],a=i[1],h=i[2];return t[0]=r*h-o*a,t[1]=o*n-s*h,t[2]=s*a-r*n,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var u,p=function(t){var e=t[0],i=t[1],s=t[2];return Math.hypot(e,i,s)};u=c();!function(){var t,e=(t=new a(4),a!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();function v(){var t=new a(4);return a!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function _(t,e,i,s){var r,o,n,a,h,c=e[0],l=e[1],d=e[2],u=e[3],p=i[0],v=i[1],_=i[2],f=i[3];return(o=c*p+l*v+d*_+u*f)<0&&(o=-o,p=-p,v=-v,_=-_,f=-f),1-o>1e-6?(r=Math.acos(o),n=Math.sin(r),a=Math.sin((1-s)*r)/n,h=Math.sin(s*r)/n):(a=1-s,h=s),t[0]=a*c+h*p,t[1]=a*l+h*v,t[2]=a*d+h*_,t[3]=a*u+h*f,t}var f,w,g,m,y,R,M,E=function(t,e){var i=e[0],s=e[1],r=e[2],o=e[3],n=i*i+s*s+r*r+o*o;return n>0&&(n=1/Math.sqrt(n)),t[0]=i*n,t[1]=s*n,t[2]=r*n,t[3]=o*n,t};f=c(),w=l(1,0,0),g=l(0,1,0),m=v(),y=v(),R=new a(9),a!=Float32Array&&(R[1]=0,R[2]=0,R[3]=0,R[5]=0,R[6]=0,R[7]=0),R[0]=1,R[4]=1,R[8]=1,M=R;class T{}class A{constructor(t,e,i,s){this._processing=!1,this.position=c(),this.rotation=v(),this._dispatcher=t,this.markerURL=e,this.vw=i,this.vh=s}initialize(t){return new Promise(((e,i)=>{this.worker=new o.default,this.worker.onmessage=i=>{this.load(t).then((()=>{this.worker.onmessage=t=>{let e;if("found"==t.data.type){let i=this.getArrayMatrix(JSON.parse(t.data.matrixGL_RH)),s=function(t,e,i,s,r,o,n,h,c,l,d,u,p,v,_,f){var w=new a(16);return w[0]=t,w[1]=e,w[2]=i,w[3]=s,w[4]=r,w[5]=o,w[6]=n,w[7]=h,w[8]=c,w[9]=l,w[10]=d,w[11]=u,w[12]=p,w[13]=v,w[14]=_,w[15]=f,w}(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9],i[10],i[11],i[12],i[13],i[14],i[15]);!function(t,e){t[0]=e[12],t[1]=e[13],t[2]=e[14]}(this.position,s),h(this.rotation,s),e=new T,e.matrix=s.values(),e.position=this.position.values(),e.rotation=this.rotation.values()}this._dispatcher.found(e),this._processing=!1},e(!0)}))}}))}getArrayMatrix(t){var e=[];for(var i in t)e[i]=t[i];return e}process(t){this._processing||(this._processing=!0,this.worker.postMessage({type:"process",imagedata:t}))}load(t){return new Promise(((e,i)=>{var s=320/Math.max(this.vw,this.vh/3*4);let r=this.vw*s,o=this.vh*s,n=Math.max(r,o/3*4),a=Math.max(o,r/4*3);this.worker.postMessage({type:"load",pw:n,ph:a,camera_para:t,marker:this.markerURL}),this.worker.onmessage=t=>{var i=t.data;switch(i.type){case"loaded":JSON.parse(i.proj);break;case"endLoading":1==i.end&&e(!0)}this._processing=!1}}))}}class k{constructor(t,e,i,s){this._nodes=[],this._markerURL=e,this._worker=new A(this,this._markerURL,i,s),this._nodes.push(t)}initialize(t){return this._cameraURL=t,this._worker.initialize(this._cameraURL)}found(t){this._nodes.forEach((e=>{e.found(t)}))}process(t){this._worker.process(t)}update(){this._nodes.forEach((t=>{t.update()}))}destroy(){}}class x{constructor(t){this.canvas_process=document.createElement("canvas"),this.context_process=this.canvas_process.getContext("2d"),this.video=t}getHeight(){return this.vh}getWidth(){return this.vw}getImage(){return this.context_process.drawImage(this.video,0,0,this.vw,this.vh,this.ox,this.oy,this.w,this.h),this.context_process.getImageData(0,0,this.pw,this.ph)}initialize(t){return this._facing=t.facingMode||"environment",new Promise((async(t,e)=>{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var i={audio:!1,video:{facingMode:this._facing,width:{min:480,max:640}}};navigator.mediaDevices.getUserMedia(i).then((async i=>{this.video.srcObject=i,this.video=await new Promise(((t,e)=>{this.video.onloadedmetadata=()=>t(this.video)})).then((e=>{this.vw=this.video.videoWidth,this.vh=this.video.videoHeight;var i=320/Math.max(this.vw,this.vh/3*4);return this.w=this.vw*i,this.h=this.vh*i,this.pw=Math.max(this.w,this.h/3*4),this.ph=Math.max(this.h,this.w/4*3),this.ox=(this.pw-this.w)/2,this.oy=(this.ph-this.h)/2,this.canvas_process.width=this.pw,this.canvas_process.height=this.ph,this.context_process.fillStyle="black",this.context_process.fillRect(0,0,this.pw,this.ph),t(!0),e})).catch((t=>(console.log(t),e(t),null)))})).catch((t=>{console.error(t),e(t)}))}else e("Sorry, Your device does not support this experince.")}))}}class D{constructor(t,e){this.count=0,this._controllers=new Map,this._fps=15,this._lastTime=0,this._videoRenderer=t,this._cameraDataURL=e,this.setFPS(this._fps)}addNFTEntity(t,e){return e||(e="entity-"+this.count++),this._controllers.set(e,t),t}addNFTEntity2(t,e,i){i||(i="entity-"+this.count++);let s=new k(t,e,120,120);this._controllers.set(i,s)}getEntityByName(t){return this._controllers.has(t)?this._controllers.get(t):null}getCameraView(){return this._videoRenderer}setFPS(t){this._fps=1e3/t}getConf(t){return JSON.parse(function(t){let e=n.default.join(__dirname,t);const s=i.readFileSync(e,{encoding:"utf8"});return console.log(s),s}(t))}async init(t,e,i){!function(t,e){fetch(t).then((t=>{if(!t.ok)throw new Error("HTTP error, status = "+t.status);return t.json()})).then((t=>(console.log(t),e=t,console.log(e),t))).catch((function(t){return console.error(t),Promise.reject(!1)}))}(t,this.appData),console.log(this.appData),this._videoRenderer=new x(document.getElementById("video")),null!==this.appData&&await this._videoRenderer.initialize(this.appData.videoSettings).catch((t=>(console.log(t),Promise.reject(!1))));const s=new D(this._videoRenderer,e);return await s.initialize().catch((t=>(console.log(t),Promise.reject(!1)))),!0}async init2(t,e,i){let s;this._videoRenderer=new x(document.getElementById("video")),function(t,e){fetch(t).then((t=>{if(!t.ok)throw new Error("HTTP error, status = "+t.status);return t.json()})).then((t=>{console.log(t),e(t)})).catch((function(t){return console.error(t),Promise.reject(!1)}))}(t,(t=>{s=t,console.log(this.appData)})),this.appData=s,console.log(this.appData),await this._videoRenderer.initialize(this.appData.videoSettings).catch((t=>(console.log(t),Promise.reject(!1))));const r=new D(this._videoRenderer,e);return await r.initialize().catch((t=>(console.log(t),Promise.reject(!1)))),!0}async init3(t,e,i){this._videoRenderer=new x(document.getElementById("video"));const s=new D(this._videoRenderer,e);return fetch(t).then((t=>{if(!t.ok)throw new Error("HTTP error, status = "+t.status);return t.json()})).then((async t=>{console.log(t),this.appData=t,await s.initialize().then((async()=>{console.log(this.appData),await this._videoRenderer.initialize(this.appData.videoSettings).catch((t=>(console.log(t),Promise.reject(!1))))})).catch((t=>(console.log(t),Promise.reject(!1)))),console.log(this._videoRenderer)})),!0}initialize(){console.log("init ARnft");let t=[];return this._controllers.forEach((e=>{t.push(e.initialize(this._cameraDataURL))})),Promise.all(t).then((()=>!0))}update(){let t,e=Date.now();e-this._lastTime>this._fps&&(t=this._videoRenderer.getImage(),this._lastTime=e),this._controllers.forEach((e=>{e.update(),t&&e.process(t)}))}destroy(){this._controllers.forEach((t=>{t.destroy()})),this._controllers.clear(),this._videoRenderer=null}}D.EVENT_SET_CAMERA="ARNFT_SET_CAMERA_EVENT",D.EVENT_FOUND_MARKER="ARNFT_FOUND_MARKER_EVENT",D.EVENT_LOST_MARKER="ARNFT_LOST_MARKER_EVENT",t.ARnft=D,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=ARnft.js.map
